"""
[PREFIX]

###
<Task>
Predict wind power generation (MW) from meteorological forecast data.

###
<Features>
[FEATURES]

###
<Examples>
[EXAMPLES]
[SUFFIX]
"""

@evaluate.run
def evaluate(data: dict):
    """
    Evaluate the feature transformations on wind power prediction task.

    Uses Wind project's BaseLGBM with time-series K-Fold CV.
    """
    import sys
    from pathlib import Path
    import pandas as pd
    import numpy as np
    from sklearn.model_selection import KFold
    from sklearn.metrics import mean_squared_error

    # Add Wind project to Python path (modify this path on your server)
    wind_project_path = '/data/cqj-project/wind-power-forecast-mlflow-1'
    if wind_project_path not in sys.path:
        sys.path.insert(0, wind_project_path)

    from core.models.base_lgbm import BaseLGBM

    # Load data
    inputs, outputs = data['inputs'], data['outputs']

    # Apply feature transformation
    X = modify_features(inputs)
    y = outputs

    # Encode categorical columns if any
    for col in X.columns:
        if X[col].dtype == 'object' or X[col].dtype.name == 'string':
            X[col] = pd.Categorical(X[col]).codes

    # Handle missing values and infinite values
    X = X.replace([np.inf, -np.inf], np.nan)
    X = X.fillna(0)

    # Time-series K-Fold CV (no shuffle to preserve temporal order)
    kf = KFold(n_splits=4, shuffle=False)
    scores = []

    for train_idx, test_idx in kf.split(X, y):
        X_train, X_test = X.iloc[train_idx], X.iloc[test_idx]
        y_train, y_test = y[train_idx], y[test_idx]

        # Use Wind project's BaseLGBM
        model = BaseLGBM(
            model_name='llmfe_eval',
            weather_source='combined',
            params={
                'objective': 'regression',
                'metric': 'rmse',
                'learning_rate': 0.05,
                'num_leaves': 31,
                'feature_fraction': 0.9,
                'bagging_fraction': 0.8,
                'bagging_freq': 5,
                'verbose': -1
            }
        )

        try:
            # Train using Wind project's training method
            model.train(
                X_train=X_train,
                y_train=y_train,
                X_val=X_test,
                y_val=y_test,
                num_boost_round=100,
                early_stopping_rounds=10
            )

            # Predict and calculate RMSE
            y_pred = model.predict(X_test)
            rmse = np.sqrt(mean_squared_error(y_test, y_pred))
            scores.append(-rmse)  # Negative for maximization

        except Exception as e:
            # If training fails, return a very bad score
            print(f"Training error: {e}")
            scores.append(-999999)

    # Return average score
    avg_score = np.mean(scores)
    return avg_score, inputs, outputs


@equation.evolve
def modify_features(df_input) -> pd.DataFrame:
    """
    Initial feature engineering for wind power prediction.

    This is a seed function. LLM will evolve this to generate better features.

    Potential transformations:
    - Wind speed interactions: ws_100m * ws_10m
    - Pressure gradients: pmsl differences between grids
    - Non-linear transforms: log(wind_speed), wind_speed^2, wind_speed^3
    - Wind power potential: wind_speed^3 (cubic relationship)
    - Temperature-pressure interactions
    - Time-weather interactions: hour_sin * wind_speed
    """
    import pandas as pd
    import numpy as np

    df_output = df_input.copy()

    # LLM will generate feature transformations here

    return df_output
